Bootstrap: docker
From: openfoamplus/of_v1706_centos73

%environment
    export MPICH_DIR=/opt/4.0.3
    export SINGULARITY_MPICH_DIR=$MPICH_DIR
    export SINGULARITYENV_APPEND_PATH=$MPICH_DIR/bin
    export SINGULAIRTYENV_APPEND_LD_LIBRARY_PATH=$MPICH_DIR/lib


%post -c /bin/bash

    yum -y update
    yum install -y git gnuplot bc python3

    # OpenMPI
    # Information about the version of MPICH to use
    export MPICH_VERSION=4.0.3
    export MPICH_URL="http://www.mpich.org/static/downloads/$MPICH_VERSION/mpich-$MPICH_VERSION.tar.gz"
    export MPICH_DIR=/opt/mpich

    echo "Installing MPICH..."
    mkdir -p /tmp/mpich
    mkdir -p /opt
    # Download
    cd /tmp/mpich && wget -O mpich-$MPICH_VERSION.tar.gz $MPICH_URL && tar xzf mpich-$MPICH_VERSION.tar.gz
    # Compile and install
    cd /tmp/mpich/mpich-$MPICH_VERSION && ./configure --prefix=$MPICH_DIR --disable-fortran && make install
    # Set env variables so we can compile our application
    export PATH=$MPICH_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$MPICH_DIR/lib:$LD_LIBRARY_PATH
    export MANPATH=$MPICH_DIR/share/man:$MANPATH

    # OpenFOAM
    mkdir -p /opt/OpenFOAM/user-v1706 && cd /opt/OpenFOAM/user-v1706
    sed -i 's/WM_PROJECT_USER_DIR=.*/WM_PROJECT_USER_DIR=\/opt\/OpenFOAM\/user-v1706/' /opt/OpenFOAM/OpenFOAM-v1706/etc/bashrc
    source /opt/OpenFOAM/OpenFOAM-v1706/etc/bashrc

    # hyStrath-1706 clone and install
    git clone -b docker-1706 --single-branch https://github.com/vincentcasseau/hyStrath-UniBw.git
    cd hyStrath-UniBw 
    chmod +x install.sh 
    ./install.sh


# Scratch
    # gcc-7
    # yum install -y centos-release-scl
    # yum install -y devtoolset-7-gcc-*
    # source scl_source enable devtoolset-7
    # Source the OpenFOAM environment and run-functions
    # . /usr/lib/openfoam/openfoam2206/etc/bashrc
    # . $WM_PROJECT_DIR/bin/tools/RunFunctions

# %files
#     src/OpenFOAM-v1706.tgz /usr/lib/
#     src/ThirdParty-v1706.tgz /usr/lib/