Bootstrap: docker
From: openfoamplus/of_v1706_centos73

%environment
    # export OMPI_DIR=/opt/ompi
    # export SINGULARITY_OMPI_DIR=$OMPI_DIR
    # export SINGULARITYENV_APPEND_PATH=$OMPI_DIR/bin
    # export SINGULAIRTYENV_APPEND_LD_LIBRARY_PATH=$OMPI_DIR/lib
    # Source the OpenFOAM environment and run-functions
    # . /usr/lib/openfoam/openfoam2206/etc/bashrc
    # . $WM_PROJECT_DIR/bin/tools/RunFunctions

# %files
#     src/OpenFOAM-v1706.tgz /usr/lib/
#     src/ThirdParty-v1706.tgz /usr/lib/

%post -c /bin/bash

    # gcc-7
    yum -y update
    # yum install -y centos-release-scl
    # yum install -y devtoolset-7-gcc-*
    # source scl_source enable devtoolset-7

    yum install -y git gnuplot bc
    # echo "deb [arch=amd64] http://archive.ubuntu.com/ubuntu focal main universe" >> /etc/apt/sources.list


    # echo "Installing required packages..."
    # apt-get -y update
    # apt-get install -y gcc-7 build-essential gcc g++ wget git bash make cmake file bc automake bzip2 \ 
    # build-essential autoconf autotools-dev cmake gawk gnuplot \
    # flex libfl-dev libreadline-dev zlib1g-dev openmpi-bin libopenmpi-dev mpi-default-bin mpi-default-dev \
    # libgmp-dev libmpfr-dev libmpc-dev

    # # # echo "Installing Open MPI"
    # # # export OMPI_DIR=/opt/ompi
    # # # export OMPI_VERSION=4.1.4
    # # # export OMPI_URL="https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.4.tar.bz2"
    # # # mkdir -p /tmp/ompi
    # # # mkdir -p /opt
    # # # # Download
    # # # cd /tmp/ompi && wget -O openmpi-$OMPI_VERSION.tar.bz2 $OMPI_URL && tar -xjf openmpi-$OMPI_VERSION.tar.bz2
    # # # # Compile and install
    # # # cd /tmp/ompi/openmpi-$OMPI_VERSION && ./configure --prefix=$OMPI_DIR && make -j install
    # # # # Set env variables so we can compile our application
    # # # export PATH=$OMPI_DIR/bin:$PATH
    # # # export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH
    # Activate OpenFOAM environment
    mkdir -p /opt/OpenFOAM/user-v1706 && cd /opt/OpenFOAM/user-v1706
    sed -i 's/WM_PROJECT_USER_DIR=.*/WM_PROJECT_USER_DIR=\/opt\/OpenFOAM\/user-v1706/' /opt/OpenFOAM/OpenFOAM-v1706/etc/bashrc
    source /opt/OpenFOAM/OpenFOAM-v1706/etc/bashrc
    # CC=$(which gcc-7)
    # CXX=$(which g++-7)
    # cd /usr/lib/openfoam/ThirdParty-v1706
    # ./Allwmake -j

    # # # hyStrath Installation

    # Clone files and install
    git clone -b docker-1706 --single-branch https://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@github.com/vincentcasseau/hyStrath-UniBw.git
    cd hyStrath-UniBw 
    chmod +x install.sh 
    ./install.sh
